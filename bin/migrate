#!/usr/bin/env php
<?php

declare(strict_types=1);

use Fred\Infrastructure\Config\ConfigLoader;
use Fred\Infrastructure\Database\ConnectionFactory;
use Fred\Infrastructure\Database\DatabaseResetter;
use Fred\Infrastructure\Database\Migration\MigrationRunner;
use Fred\Infrastructure\Env\DotenvLoader;

$autoload = __DIR__ . '/../vendor/autoload.php';
if (file_exists($autoload)) {
    require $autoload;
}

$basePath = dirname(__DIR__);
$env = DotenvLoader::load($basePath . '/.env');
$config = ConfigLoader::fromArray($env, $basePath);

$fresh = in_array('--fresh', $argv, true) || in_array('fresh', $argv, true);
if ($fresh) {
    (new DatabaseResetter($config))->fresh();
}

$pdo = ConnectionFactory::make($config);

$runner = new MigrationRunner($pdo, $basePath . '/migrations');

try {
    $runner->run();
    fwrite(STDOUT, $fresh ? "Database refreshed and migrations completed.\n" : "Migrations completed.\n");
    exit(0);
} catch (Throwable $exception) {
    fwrite(STDERR, 'Migration failed: ' . $exception->getMessage() . "\n");
    exit(1);
}
