#!/usr/bin/env php
<?php

declare(strict_types=1);

use Fred\Application\Seed\DemoSeeder;
use Fred\Infrastructure\Config\ConfigLoader;
use Fred\Infrastructure\Database\BoardRepository;
use Fred\Infrastructure\Database\CategoryRepository;
use Fred\Infrastructure\Database\CommunityRepository;
use Fred\Infrastructure\Database\ConnectionFactory;
use Fred\Infrastructure\Database\CommunityModeratorRepository;
use Fred\Infrastructure\Database\PostRepository;
use Fred\Infrastructure\Database\RoleRepository;
use Fred\Infrastructure\Database\ThreadRepository;
use Fred\Infrastructure\Database\ProfileRepository;
use Fred\Infrastructure\Database\UserRepository;
use Fred\Infrastructure\Database\MentionNotificationRepository;
use Fred\Infrastructure\Env\DotenvLoader;
use Fred\Application\Seed\CustomThemeSeeder;
use Fred\Application\Seed\ProgressTracker;
use Fred\Infrastructure\Database\ReactionRepository;
use Fred\Application\Content\EmoticonSet;
use Fred\Application\Content\MentionService;
use Faker\Factory as FakerFactory;

$autoload = __DIR__ . '/../vendor/autoload.php';
if (file_exists($autoload)) {
    require $autoload;
}

$basePath = dirname(__DIR__);
$env = DotenvLoader::load($basePath . '/.env');
$config = ConfigLoader::fromArray($env, $basePath);
$pdo = ConnectionFactory::make($config);

$faker = FakerFactory::create();
$faker->seed(1234);

$boardCount = (int) ($argv[1] ?? 4);
$threadsPerBoard = (int) ($argv[2] ?? 30);
$postsPerThread = (int) ($argv[3] ?? 30);
$userCount = (int) ($argv[4] ?? 50);

$progress = new ProgressTracker(static function (string $message): void {
    fwrite(STDOUT, "[seed] {$message}\n");
});

$seeder = new DemoSeeder(
    roles: new RoleRepository($pdo),
    users: new UserRepository($pdo),
    communities: new CommunityRepository($pdo),
    categories: new CategoryRepository($pdo),
    boards: new BoardRepository($pdo),
    threads: new ThreadRepository($pdo),
    posts: new PostRepository($pdo),
    profiles: new ProfileRepository($pdo),
    communityModerators: new CommunityModeratorRepository($pdo),
    mentions: new MentionService(new UserRepository($pdo), new MentionNotificationRepository($pdo)),
    faker: $faker,
    config: $config,
    reactions: new ReactionRepository($pdo),
    boardCount: max(1, $boardCount),
    threadsPerBoard: max(1, $threadsPerBoard),
    postsPerThread: max(1, $postsPerThread),
    userCount: max(2, $userCount),
    parser: null,
    progress: $progress,
    emoticons: new EmoticonSet($config),
);

// Themed community/boards showcase
$themedSeeder = new CustomThemeSeeder(
    communities: new CommunityRepository($pdo),
    categories: new CategoryRepository($pdo),
    boards: new BoardRepository($pdo),
    progress: $progress,
);

try {
    $result = $seeder->seed();
    $themedSeeder->seed();
    $communityIds = $result['community_ids'] ?? [];
    $userIds = $result['user_ids'] ?? [];
    $boardIds = $result['board_ids'] ?? [];

    $communityId = $communityIds[0] ?? '';
    $userId = $userIds[0] ?? '';
    $boardCountOutput = is_countable($boardIds) ? count($boardIds) : 0;

    fwrite(STDOUT, "Seeded demo data. Community ID: {$communityId}, Boards: {$boardCountOutput}, User ID: {$userId}.\n");
    exit(0);
} catch (Throwable $exception) {
    fwrite(STDERR, 'Seeding failed: ' . $exception->getMessage() . "\n");
    exit(1);
}
